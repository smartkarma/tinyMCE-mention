!function(f){"use strict";if("object"==typeof exports&&"undefined"!=typeof module)module.exports=f(require("jquery"));else if("function"==typeof define&&define.amd)define(["jquery"],f);else{var g;g="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,f(g.jQuery)}}(function($){"use strict";var AutoComplete=function(ed,options){this.editor=ed,this.options=$.extend({},{source:[],delay:500,queryBy:"name",items:10},options),this.matcher=this.options.matcher||this.matcher,this.renderDropdown=this.options.renderDropdown||this.renderDropdown,this.render=this.options.render||this.render,this.insert=this.options.insert||this.insert,this.highlighter=this.options.highlighter||this.highlighter,this.query="",this.hasFocus=!0,this.renderInput(),this.lookup(),this.bindEvents()};AutoComplete.prototype={constructor:AutoComplete,renderInput:function(){var rawHtml='<span id="autocomplete"><span id="autocomplete-delimiter">'+this.options.delimiter+'</span><span id="autocomplete-searchtext"><span class="dummy">\ufeff</span></span></span>';this.editor.execCommand("mceInsertContent",!1,rawHtml),this.editor.focus(),this.editor.selection.select(this.editor.selection.dom.select("span#autocomplete-searchtext span")[0]),this.editor.selection.collapse(0)},bindEvents:function(){this.editor.on("keyup",this.editorKeyUpProxy=$.proxy(this.rteKeyUp,this)),this.editor.on("keydown",this.editorKeyDownProxy=$.proxy(this.rteKeyDown,this),!0),this.editor.on("click",this.editorClickProxy=$.proxy(this.rteClicked,this)),$("body").on("click",this.bodyClickProxy=$.proxy(this.rteLostFocus,this))},unbindEvents:function(){this.editor.off("keyup",this.editorKeyUpProxy),this.editor.off("keydown",this.editorKeyDownProxy),this.editor.off("click",this.editorClickProxy),$("body").off("click",this.bodyClickProxy)},rteKeyUp:function(e){switch(e.which||e.keyCode){case 40:case 38:case 16:case 17:case 18:break;case 8:case 32:""===this.query?(this.cleanUp(!0),e.stopPropagation()):this.lookup();break;case 9:case 13:var item=void 0!==this.$dropdown?this.$dropdown.find("li.active"):[];item.length?(this.select(item.data()),this.cleanUp(!1)):this.cleanUp(!0);break;case 27:this.cleanUp(!0);break;default:this.lookup()}},rteKeyDown:function(e){switch(e.which||e.keyCode){case 9:case 13:case 27:e.preventDefault();break;case 32:""===this.query&&e.preventDefault();break;case 38:e.preventDefault(),void 0!==this.$dropdown&&this.highlightPreviousResult();break;case 40:e.preventDefault(),void 0!==this.$dropdown&&this.highlightNextResult()}e.stopPropagation()},rteClicked:function(e){var $target=$(e.target);this.hasFocus&&"autocomplete-searchtext"!==$target.parent().attr("id")&&this.cleanUp(!0)},rteLostFocus:function(){this.hasFocus&&this.cleanUp(!0)},lookup:function(){this.query=$.trim($(this.editor.getBody()).find("#autocomplete-searchtext").text()).replace("\ufeff",""),void 0===this.$dropdown&&this.show(),clearTimeout(this.searchTimeout),this.searchTimeout=setTimeout($.proxy(function(){var items=$.isFunction(this.options.source)?this.options.source(this.query,$.proxy(this.process,this),this.options.delimiter):this.options.source;items&&this.process(items)},this),this.options.delay)},matcher:function(item){return~item[this.options.queryBy].toLowerCase().indexOf(this.query.toLowerCase())},sorter:function(items){for(var item,beginswith=[],caseSensitive=[],caseInsensitive=[];void 0!==(item=items.shift());)item[this.options.queryBy].toLowerCase().indexOf(this.query.toLowerCase())?~item[this.options.queryBy].indexOf(this.query)?caseSensitive.push(item):caseInsensitive.push(item):beginswith.push(item);return beginswith.concat(caseSensitive,caseInsensitive)},highlighter:function(text){return text.replace(new RegExp("("+this.query.replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1")+")","ig"),function($1,match){return"<strong>"+match+"</strong>"})},show:function(){var offset=this.editor.inline?this.offsetInline():this.offset(),dropdown='<div class="rte-autocomplete-container"><span class="tail --shadow"></span><span class="tail --foreground"></span>'+this.renderDropdown()+"</div>";this.$dropdown=$(dropdown).css({top:offset.top,left:offset.left}),$("body").append(this.$dropdown),this.adjustPosition(),this.$dropdown.on("click",$.proxy(this.autoCompleteClick,this))},process:function(data){if(this.hasFocus){var _this=this,result=[],items=$.grep(data,function(item){return _this.matcher(item)});items=_this.sorter(items),items=items.slice(0,this.options.items),$.each(items,function(i,item){var $element=$(_this.render(item));$element.html($element.html().replace($element.text(),_this.highlighter($element.text()))),$.each(items[i],function(key,val){$element.attr("data-"+key,val)}),result.push($element[0].outerHTML)}),result.length?this.$dropdown.find(".rte-autocomplete").html(result.join("")).show():this.$dropdown.hide()}},renderDropdown:function(){return'<ul class="rte-autocomplete dropdown-menu"><li class="loading"></li></ul>'},render:function(item){return'<li><a href="javascript:;"><span>'+item[this.options.queryBy]+"</span></a></li>"},autoCompleteClick:function(e){var item=$(e.target).closest("li").data();$.isEmptyObject(item)||(this.select(item),this.cleanUp(!1)),e.stopPropagation(),e.preventDefault()},highlightPreviousResult:function(){var currentIndex=this.$dropdown.find("li.active").index(),index=0===currentIndex?this.$dropdown.find("li").length-1:--currentIndex;this.$dropdown.find("li").removeClass("active").eq(index).addClass("active")},highlightNextResult:function(){var currentIndex=this.$dropdown.find("li.active").index(),index=currentIndex===this.$dropdown.find("li").length-1?0:++currentIndex;this.$dropdown.find("li").removeClass("active").eq(index).addClass("active")},select:function(item){this.editor.focus();var selection=this.editor.dom.select("span#autocomplete")[0];this.editor.dom.remove(selection),this.editor.execCommand("mceInsertContent",!1,this.insert(item))},insert:function(item){return"<span>"+item[this.options.queryBy]+"</span>&nbsp;"},cleanUp:function(rollback){this.unbindEvents(),this.hasFocus=!1;var $selection=$(this.editor.dom.select("span#autocomplete"));if((void 0===this.$dropdown&&$selection.length||(this.$dropdown.remove(),delete this.$dropdown,$selection.length))&&rollback){var text=this.query,replacement=$("<p>"+this.options.delimiter+text+"</p>")[0].firstChild,focus=$(this.editor.selection.getNode()).offset().top===$selection.offset().top+($selection.outerHeight()-$selection.height())/2;this.editor.dom.replace(replacement,$selection[0]),focus&&(this.editor.selection.select(replacement),this.editor.selection.collapse())}},offset:function(){var rtePosition=$(this.editor.getContainer()).offset(),contentAreaPosition=$(this.editor.getContentAreaContainer()).position(),nodePosition=$(this.editor.dom.select("span#autocomplete")).position();return{top:rtePosition.top+contentAreaPosition.top+nodePosition.top+$(this.editor.selection.getNode()).innerHeight()-$(this.editor.getDoc()).scrollTop()+5,left:rtePosition.left+contentAreaPosition.left+nodePosition.left}},offsetInline:function(){var nodePosition=$(this.editor.dom.select("span#autocomplete")).offset();return{top:nodePosition.top+$(this.editor.selection.getNode()).innerHeight()+5,left:nodePosition.left}},adjustPosition:function(){var $dropdown=this.$dropdown,offsetLeft=$dropdown.offset().left,distanceToRight=$(window).width()-(offsetLeft+$dropdown.width()+5);distanceToRight>0||($dropdown.css("left",offsetLeft+distanceToRight),$.each($dropdown.find(".tail"),function(i,item){var element=$(item);element.css("left",element.position().left-distanceToRight)}))}},tinymce.create("tinymce.plugins.Mention",{init:function(ed){function checkDelimiter(){var range=ed.selection.getRng(!0);if(range.startOffset!==range.endOffset)return-1;var current=range.startOffset,text=ed.selection.getRng(!0).startContainer.data||"",space=text.slice(current-2,current-1),character=text.slice(current-1,current);return $.trim(space)?-1:$.inArray(character,autoCompleteData.delimiter)}var autoComplete,autoCompleteData=ed.getParam("mentions");autoCompleteData.delimiter=void 0!==autoCompleteData.delimiter?$.isArray(autoCompleteData.delimiter)?autoCompleteData.delimiter:[autoCompleteData.delimiter]:["@"],ed.on("keyup",function(e){if(8!==e.which&&8!==e.keyCode&&"Backspace"!==e.key){var delimiterIndex=checkDelimiter();if(delimiterIndex>-1&&(void 0===autoComplete||void 0!==autoComplete.hasFocus&&!autoComplete.hasFocus)){e.preventDefault();try{var range=ed.selection.getRng(!0);range.setStart(range.startContainer,range.startOffset-1),ed.selection.setRng(range)}catch(e){}autoComplete=new AutoComplete(ed,$.extend({},autoCompleteData,{delimiter:autoCompleteData.delimiter[delimiterIndex]}))}}})},getInfo:function(){return{longname:"mention",author:"Steven Devooght",version:tinymce.majorVersion+"."+tinymce.minorVersion}}}),tinymce.PluginManager.add("mention",tinymce.plugins.Mention)});